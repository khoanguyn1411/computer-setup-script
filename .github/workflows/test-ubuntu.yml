name: Test Ubuntu Setup

on:
  push:
    branches: [main]
    paths:
      - "scripts/ubuntu/**"
      - "shared/**"
      - ".github/workflows/test-ubuntu.yml"
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment: local (run all) or ci (skip if no GPU)'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - ci

jobs:
  test-ubuntu-setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display Ubuntu version
        run: |
          lsb_release -a
          echo "Shell: $SHELL"

      - name: Test script syntax
        run: |
          echo "ğŸ” Checking script syntax..."
          bash -n scripts/ubuntu/setup.sh
          bash -n scripts/ubuntu/installations/*.sh
          bash -n shared/unix-base-installation/*.sh
          echo "âœ… All scripts have valid syntax"

      - name: Run Ubuntu setup
        env:
          SETUP_ENV: ${{ github.event.inputs.env || 'local' }}
        run: |
          cd scripts/ubuntu
          bash setup.sh

      - name: Verify installations
        run: |
          echo "ğŸ” Verifying installations..."

          # Check Zsh and Oh My Zsh
          if command -v zsh &> /dev/null; then
            echo "âœ… Zsh installed: $(zsh --version)"
          else
            echo "âŒ Zsh not found"
            exit 1
          fi

          if [ -d "$HOME/.oh-my-zsh" ]; then
            echo "âœ… Oh My Zsh installed"
          else
            echo "âŒ Oh My Zsh not found"
            exit 1
          fi

          # Check NVM and Node
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          if command -v nvm &> /dev/null; then
            echo "âœ… NVM installed: $(nvm --version)"
          else
            echo "âŒ NVM not found"
            exit 1
          fi

          if command -v node &> /dev/null; then
            echo "âœ… Node.js installed: $(node --version)"
          else
            echo "âŒ Node.js not found"
            exit 1
          fi

          if command -v yarn &> /dev/null; then
            echo "âœ… Yarn installed: $(yarn --version)"
          else
            echo "âŒ Yarn not found"
            exit 1
          fi

          # Check Docker
          if command -v docker &> /dev/null; then
            echo "âœ… Docker installed: $(docker --version)"
          else
            echo "âŒ Docker not found"
            exit 1
          fi

          # Check SSH key
          if [ -f "$HOME/.ssh/personal" ]; then
            echo "âœ… SSH key generated"
          else
            echo "âŒ SSH key not found"
            exit 1
          fi

          # Check .zshrc
          if [ -f "$HOME/.zshrc" ]; then
            echo "âœ… .zshrc created"
          else
            echo "âŒ .zshrc not found"
            exit 1
          fi

          echo ""
          echo "ğŸ‰ All verifications passed!"

      - name: Display .zshrc contents
        run: |
          echo "ğŸ“„ Contents of ~/.zshrc:"
          echo "====================================="
          cat ~/.zshrc
          echo "====================================="

      - name: Test Zsh configuration
        shell: zsh {0}
        run: |
          source ~/.zshrc
          echo "âœ… Zsh configuration loaded successfully"

          # Test some aliases exist
          alias gc &> /dev/null && echo "âœ… Git aliases loaded" || echo "âŒ Git aliases missing"
          alias ns &> /dev/null && echo "âœ… Node aliases loaded" || echo "âŒ Node aliases missing"
          alias dockerCleanAll &> /dev/null && echo "âœ… Docker aliases loaded" || echo "âŒ Docker aliases missing"

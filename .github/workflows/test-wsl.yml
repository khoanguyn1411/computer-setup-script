name: Test WSL Setup

on:
  push:
    branches: [main]
    paths:
      - "scripts/ubuntu/**"
      - "shared/**"
      - ".github/workflows/test-wsl.yml"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-wsl-setup:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup WSL
        uses: Vampire/setup-wsl@v3
        with:
          distribution: Ubuntu-22.04

      - name: Copy repository to WSL
        shell: wsl-bash {0}
        run: |
          set -e
          # Copy from Windows path to WSL filesystem
          # The current directory in WSL is the mounted Windows workspace
          CURRENT_DIR="$(pwd)"
          echo "Current directory (Windows mount): $CURRENT_DIR"

          WSL_WORKSPACE="/home/$(whoami)/workspace"
          mkdir -p "$WSL_WORKSPACE"
          cp -r "$CURRENT_DIR" "$WSL_WORKSPACE/computer-setup-script"
          echo "Repository copied to: $WSL_WORKSPACE/computer-setup-script"

          # Convert line endings from CRLF to LF
          echo "Converting line endings to Unix format..."
          find "$WSL_WORKSPACE/computer-setup-script" -type f \( -name "*.sh" -o -name "*.yml" -o -name "*.yaml" \) -exec dos2unix {} \; 2>/dev/null || \
          find "$WSL_WORKSPACE/computer-setup-script" -type f \( -name "*.sh" -o -name "*.yml" -o -name "*.yaml" \) -exec sed -i 's/\r$//' {} \;

          echo "Line endings converted"
          ls -la "$WSL_WORKSPACE/computer-setup-script"

      - name: Display WSL info
        shell: wsl-bash {0}
        run: |
          WSL_WORKSPACE="/home/$(whoami)/workspace/computer-setup-script"
          cd "$WSL_WORKSPACE"
          lsb_release -a
          echo "Shell: $SHELL"
          echo "Current directory: $(pwd)"
          echo "Listing current directory:"
          ls -la
          # Check if running in WSL
          if grep -qi microsoft /proc/version 2>/dev/null || [ -n "$WSL_DISTRO_NAME" ]; then
            echo "âœ… Running in WSL"
          else
            echo "âŒ Not running in WSL"
          fi

      - name: Test script syntax
        shell: wsl-bash {0}
        run: |
          WSL_WORKSPACE="/home/$(whoami)/workspace/computer-setup-script"
          cd "$WSL_WORKSPACE"
          echo "Working in: $(pwd)"
          echo "ğŸ” Checking script syntax..."
          bash -n scripts/ubuntu/setup.sh
          bash -n scripts/ubuntu/installations/*.sh
          bash -n shared/unix-base-installation/*.sh
          echo "âœ… All scripts have valid syntax"

      - name: Run WSL setup
        shell: wsl-bash {0}
        run: |
          WSL_WORKSPACE="/home/$(whoami)/workspace/computer-setup-script"
          cd "$WSL_WORKSPACE/scripts/ubuntu"
          bash setup.sh

      - name: Verify installations
        shell: wsl-bash {0}
        run: |
          WSL_WORKSPACE="/home/$(whoami)/workspace/computer-setup-script"
          cd "$WSL_WORKSPACE"
          echo "ğŸ” Verifying installations..."

          # Check Zsh and Oh My Zsh
          if command -v zsh &> /dev/null; then
            echo "âœ… Zsh installed: $(zsh --version)"
          else
            echo "âŒ Zsh not found"
            exit 1
          fi

          if [ -d "$HOME/.oh-my-zsh" ]; then
            echo "âœ… Oh My Zsh installed"
          else
            echo "âŒ Oh My Zsh not found"
            exit 1
          fi

          # Check NVM and Node
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          if command -v nvm &> /dev/null; then
            echo "âœ… NVM installed: $(nvm --version)"
          else
            echo "âŒ NVM not found"
            exit 1
          fi

          if command -v node &> /dev/null; then
            echo "âœ… Node.js installed: $(node --version)"
          else
            echo "âŒ Node.js not found"
            exit 1
          fi

          if command -v yarn &> /dev/null; then
            echo "âœ… Yarn installed: $(yarn --version)"
          else
            echo "âŒ Yarn not found"
            exit 1
          fi

          # Check Docker
          if command -v docker &> /dev/null; then
            echo "âœ… Docker installed: $(docker --version)"
          else
            echo "âŒ Docker not found"
            exit 1
          fi

          # Check SSH key
          if [ -f "$HOME/.ssh/personal" ]; then
            echo "âœ… SSH key generated"
          else
            echo "âŒ SSH key not found"
            exit 1
          fi

          # Check .zshrc
          if [ -f "$HOME/.zshrc" ]; then
            echo "âœ… .zshrc created"
          else
            echo "âŒ .zshrc not found"
            exit 1
          fi

          # Check WSL launchers
          if [ -f "$HOME/windsurf-launcher.sh" ]; then
            echo "âœ… Windsurf launcher created"
          else
            echo "âŒ Windsurf launcher not found"
            exit 1
          fi

          if [ -f "$HOME/antigravity-launcher.sh" ]; then
            echo "âœ… Antigravity launcher created"
          else
            echo "âŒ Antigravity launcher not found"
            exit 1
          fi

          echo ""
          echo "ğŸ‰ All verifications passed!"

      - name: Display .zshrc contents
        shell: wsl-bash {0}
        run: |
          WSL_WORKSPACE="/home/$(whoami)/workspace/computer-setup-script"
          cd "$WSL_WORKSPACE"
          echo "ğŸ“„ Contents of ~/.zshrc:"
          echo "====================================="
          cat ~/.zshrc
          echo "====================================="

      - name: Test Zsh configuration
        shell: wsl-bash {0}
        run: |
          WSL_WORKSPACE="/home/$(whoami)/workspace/computer-setup-script"
          cd "$WSL_WORKSPACE"
          source ~/.zshrc
          echo "âœ… Zsh configuration loaded successfully"

          # Test some aliases exist
          alias gc &> /dev/null && echo "âœ… Git aliases loaded" || echo "âŒ Git aliases missing"
          alias ns &> /dev/null && echo "âœ… Node aliases loaded" || echo "âŒ Node aliases missing"
          alias wf &> /dev/null && echo "âœ… WSL IDE shortcuts loaded" || echo "âŒ WSL IDE shortcuts missing"
